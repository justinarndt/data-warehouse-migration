{
    "name": "DF_Clean_JDE",
    "type": "Microsoft.DataFactory/factories/dataflows",
    "properties": {
        "description": "Mapping Data Flow to decode JD Edwards data formats: converts Julian dates (CYYDDD to Date) and normalizes implicit decimal precision (integer to actual financial values).",
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "BronzeF4211",
                    "description": "Raw F4211 Sales Order Detail from Bronze Parquet layer",
                    "dataset": {
                        "referenceName": "ds_bronze_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "TableName": "F4211",
                            "Year": {
                                "value": "@formatDateTime(utcNow(), 'yyyy')",
                                "type": "Expression"
                            },
                            "Month": {
                                "value": "@formatDateTime(utcNow(), 'MM')",
                                "type": "Expression"
                            },
                            "Day": {
                                "value": "@formatDateTime(utcNow(), 'dd')",
                                "type": "Expression"
                            }
                        }
                    }
                }
            ],
            "sinks": [
                {
                    "name": "SilverTransactions",
                    "description": "Cleansed sales transactions written to Silver layer",
                    "dataset": {
                        "referenceName": "ds_silver_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "DomainPath": "sales/transactions"
                        }
                    }
                }
            ],
            "transformations": [
                {
                    "name": "DeriveColumns",
                    "description": "Converts JDE Julian dates to ISO dates and normalizes implicit 2-decimal financial values"
                },
                {
                    "name": "SelectCleanColumns",
                    "description": "Renames cryptic JDE column names to business-friendly aliases"
                }
            ],
            "scriptLines": [
                "source(output(",
                "    SDDOCO as integer,",
                "    SDDCTO as string,",
                "    SDAN8 as integer,",
                "    SDLITM as string,",
                "    SDTRDJ as integer,",
                "    SDUORG as integer,",
                "    SDAEXP as integer",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> BronzeF4211",
                "",
                "BronzeF4211 derive(",
                "    OrderDate = addDays(toDate(toString(1900 + toInteger(left(toString(SDTRDJ), 1)) * 100 + toInteger(substring(toString(SDTRDJ), 2, 2))) + '-01-01'), toInteger(right(toString(SDTRDJ), 3)) - 1),",
                "    ExtendedAmount = toDecimal(SDAEXP) / 100.00,",
                "    Quantity = toDecimal(SDUORG) / 100.00,",
                "    UnitPrice = iif(SDUORG != 0, toDecimal(SDAEXP) / toDecimal(SDUORG), toDecimal(0)),",
                "    DateKey = toInteger(toString(addDays(toDate(toString(1900 + toInteger(left(toString(SDTRDJ), 1)) * 100 + toInteger(substring(toString(SDTRDJ), 2, 2))) + '-01-01'), toInteger(right(toString(SDTRDJ), 3)) - 1), 'yyyyMMdd'))",
                ") ~> DeriveColumns",
                "",
                "DeriveColumns select(",
                "    mapColumn(",
                "        OrderNumber = SDDOCO,",
                "        OrderType = SDDCTO,",
                "        CustomerID = SDAN8,",
                "        ItemNumber = SDLITM,",
                "        OrderDate,",
                "        DateKey,",
                "        Quantity,",
                "        ExtendedAmount,",
                "        UnitPrice",
                "    )",
                ") ~> SelectCleanColumns",
                "",
                "SelectCleanColumns sink(",
                "    allowSchemaDrift: true,",
                "    validateSchema: false,",
                "    format: 'parquet',",
                "    truncate: true",
                ") ~> SilverTransactions"
            ]
        }
    }
}