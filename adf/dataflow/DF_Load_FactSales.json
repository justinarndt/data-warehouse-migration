{
    "name": "DF_Load_FactSales",
    "type": "Microsoft.DataFactory/factories/dataflows",
    "properties": {
        "description": "Loads Gold.Fact_Sales by joining Silver transactions with Dim_Customer (point-in-time) and Dim_Date.",
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "SilverTransactions",
                    "description": "Cleansed sales transactions from Silver layer",
                    "dataset": {
                        "referenceName": "ds_silver_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "DomainPath": "sales/transactions"
                        }
                    }
                },
                {
                    "name": "DimCustomer",
                    "description": "Customer dimension from Gold",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                },
                {
                    "name": "DimDate",
                    "description": "Date dimension from Gold",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Date"
                        }
                    }
                }
            ],
            "sinks": [
                {
                    "name": "FactSalesSink",
                    "description": "Loads into Gold.Fact_Sales",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Fact_Sales"
                        }
                    }
                }
            ],
            "transformations": [
                {
                    "name": "JoinCustomer",
                    "description": "Equi-join on CustomerID"
                },
                {
                    "name": "FilterPointInTime",
                    "description": "Filter to the correct SCD2 version by date range"
                },
                {
                    "name": "CastDateKey",
                    "description": "Ensure DateKey is integer type for joining"
                },
                {
                    "name": "JoinDate",
                    "description": "Join to Dim_Date on DateKey"
                },
                {
                    "name": "SelectFactColumns",
                    "description": "Select columns for Fact_Sales"
                }
            ],
            "scriptLines": [
                "source(output(",
                "    OrderNumber as integer,",
                "    OrderType as string,",
                "    CustomerID as integer,",
                "    ItemNumber as string,",
                "    OrderDate as date,",
                "    DateKey as integer,",
                "    Quantity as decimal(18,2),",
                "    ExtendedAmount as decimal(18,2),",
                "    UnitPrice as decimal(18,2)",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> SilverTransactions",
                "",
                "source(output(",
                "    CustomerKey as integer,",
                "    CustomerID as integer,",
                "    IsActive as boolean,",
                "    ValidFrom as timestamp,",
                "    ValidTo as timestamp",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> DimCustomer",
                "",
                "source(output(",
                "    DateKey as integer",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> DimDate",
                "",
                "SilverTransactions, DimCustomer join(",
                "    SilverTransactions@CustomerID == DimCustomer@CustomerID,",
                "    joinType: 'left',",
                "    broadcast: 'right'",
                ") ~> JoinCustomer",
                "",
                "JoinCustomer filter(",
                "    isNull(CustomerKey) || (OrderDate >= toDate(ValidFrom) && (isNull(ValidTo) || OrderDate < toDate(ValidTo)))",
                ") ~> FilterPointInTime",
                "",
                "FilterPointInTime derive(",
                "    DateKeyInt = toInteger(DateKey)",
                ") ~> CastDateKey",
                "",
                "CastDateKey, DimDate join(",
                "    DateKeyInt == DimDate@DateKey,",
                "    joinType: 'left',",
                "    broadcast: 'right'",
                ") ~> JoinDate",
                "",
                "JoinDate select(",
                "    mapColumn(",
                "        CustomerKey,",
                "        DateKey = DateKeyInt,",
                "        OrderNumber,",
                "        OrderType,",
                "        ItemNumber,",
                "        Quantity,",
                "        ExtendedAmount,",
                "        UnitPrice",
                "    )",
                ") ~> SelectFactColumns",
                "",
                "SelectFactColumns sink(",
                "    allowSchemaDrift: true,",
                "    validateSchema: false,",
                "    deletable: false,",
                "    insertable: true,",
                "    updateable: false,",
                "    upsertable: false,",
                "    format: 'table'",
                ") ~> FactSalesSink"
            ]
        }
    }
}