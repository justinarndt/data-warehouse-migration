{
    "name": "DF_SCD2_Customer",
    "type": "Microsoft.DataFactory/factories/dataflows",
    "properties": {
        "description": "SCD Type 2 for Customer dimension using SHA256 change detection and row versioning.",
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "NewCustomerData",
                    "description": "New customer records from Bronze F0101",
                    "dataset": {
                        "referenceName": "ds_bronze_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "TableName": "F0101",
                            "Year": {
                                "value": "@formatDateTime(utcNow(), 'yyyy')",
                                "type": "Expression"
                            },
                            "Month": {
                                "value": "@formatDateTime(utcNow(), 'MM')",
                                "type": "Expression"
                            },
                            "Day": {
                                "value": "@formatDateTime(utcNow(), 'dd')",
                                "type": "Expression"
                            }
                        }
                    }
                },
                {
                    "name": "ExistingDimCustomer",
                    "description": "Current active rows from Gold.Dim_Customer",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "sinks": [
                {
                    "name": "UpdateExpiredRows",
                    "description": "Expires old rows by setting IsActive=0",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                },
                {
                    "name": "InsertNewVersions",
                    "description": "Inserts new and changed customer rows",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "transformations": [
                {
                    "name": "HashNewData",
                    "description": "SHA256 hash of business columns in new data"
                },
                {
                    "name": "HashExistingData",
                    "description": "SHA256 hash of business columns in existing data"
                },
                {
                    "name": "LookupExisting",
                    "description": "Match new to existing on business key"
                },
                {
                    "name": "SplitByChangeStatus",
                    "description": "Route to NewRecords, ChangedRecords, NoChange"
                },
                {
                    "name": "SetExpiredColumns",
                    "description": "Set IsActive=false and ValidTo for expired rows"
                },
                {
                    "name": "MarkForUpdate",
                    "description": "Mark rows for update operation"
                },
                {
                    "name": "UnionForInsert",
                    "description": "Combine new and changed records for insertion"
                },
                {
                    "name": "SetInsertColumns",
                    "description": "Map columns for the insert sink"
                },
                {
                    "name": "MarkForInsert",
                    "description": "Mark rows for insert operation"
                }
            ],
            "scriptLines": [
                "source(output(",
                "    ABAN8 as integer,",
                "    ABALPH as string,",
                "    ABAT1 as string,",
                "    ABAC01 as string,",
                "    ABUPMJ as integer",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> NewCustomerData",
                "",
                "source(output(",
                "    CustomerKey as integer,",
                "    CustomerID as integer,",
                "    CustomerName as string,",
                "    SearchType as string,",
                "    CategoryCode as string,",
                "    IsActive as boolean,",
                "    ValidFrom as timestamp,",
                "    ValidTo as timestamp,",
                "    RowHash as string",
                "),",
                "allowSchemaDrift: true,",
                "validateSchema: false) ~> ExistingDimCustomer",
                "",
                "NewCustomerData derive(",
                "    NewHash = sha2(256, ABALPH, ABAT1, ABAC01)",
                ") ~> HashNewData",
                "",
                "ExistingDimCustomer derive(",
                "    ExistingHash = sha2(256, CustomerName, SearchType, CategoryCode)",
                ") ~> HashExistingData",
                "",
                "HashNewData, HashExistingData lookup(",
                "    ABAN8 == CustomerID,",
                "    multiple: false,",
                "    broadcast: 'right'",
                ") ~> LookupExisting",
                "",
                "LookupExisting split(",
                "    isNull(CustomerKey),",
                "    !isNull(CustomerKey) && NewHash != ExistingHash,",
                "    disjoint: false",
                ") ~> SplitByChangeStatus@(NewRecords, ChangedRecords, NoChange)",
                "",
                "SplitByChangeStatus@ChangedRecords derive(",
                "    IsActive = toBoolean('false'),",
                "    ValidTo = currentUTC(),",
                "    ModifiedDate = currentUTC()",
                ") ~> SetExpiredColumns",
                "",
                "SetExpiredColumns alterRow(",
                "    updateIf: toBoolean('true')",
                ") ~> MarkForUpdate",
                "",
                "SplitByChangeStatus@NewRecords, SplitByChangeStatus@ChangedRecords union(",
                "    byName: true",
                ") ~> UnionForInsert",
                "",
                "UnionForInsert select(",
                "    mapColumn(",
                "        CustomerID = ABAN8,",
                "        CustomerName = ABALPH,",
                "        SearchType = ABAT1,",
                "        CategoryCode = ABAC01,",
                "        RowHash = NewHash",
                "    )",
                ") ~> SetInsertColumns",
                "",
                "SetInsertColumns alterRow(",
                "    insertIf: toBoolean('true')",
                ") ~> MarkForInsert",
                "",
                "MarkForUpdate sink(",
                "    allowSchemaDrift: true,",
                "    validateSchema: false,",
                "    deletable: false,",
                "    insertable: false,",
                "    updateable: true,",
                "    upsertable: false,",
                "    keys: ['CustomerKey'],",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerKey,",
                "        IsActive,",
                "        ValidTo,",
                "        ModifiedDate",
                "    ),",
                "    sinkOrder: 1",
                ") ~> UpdateExpiredRows",
                "",
                "MarkForInsert sink(",
                "    allowSchemaDrift: true,",
                "    validateSchema: false,",
                "    deletable: false,",
                "    insertable: true,",
                "    updateable: false,",
                "    upsertable: false,",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerID,",
                "        CustomerName,",
                "        SearchType,",
                "        CategoryCode,",
                "        RowHash",
                "    ),",
                "    sinkOrder: 2",
                ") ~> InsertNewVersions"
            ]
        }
    }
}