{
    "name": "DF_SCD2_Customer",
    "type": "Microsoft.DataFactory/factories/dataflows",
    "properties": {
        "description": "Mapping Data Flow implementing Slowly Changing Dimensions Type 2 for the Customer dimension. Uses SHA256 hashing for efficient change detection and manages row versioning.",
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "NewCustomerData",
                    "description": "New/updated customer records from Bronze F0101 Parquet",
                    "dataset": {
                        "referenceName": "ds_bronze_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "TableName": "F0101",
                            "Year": {
                                "value": "@formatDateTime(utcNow(), 'yyyy')",
                                "type": "Expression"
                            },
                            "Month": {
                                "value": "@formatDateTime(utcNow(), 'MM')",
                                "type": "Expression"
                            },
                            "Day": {
                                "value": "@formatDateTime(utcNow(), 'dd')",
                                "type": "Expression"
                            }
                        }
                    }
                },
                {
                    "name": "ExistingDimCustomer",
                    "description": "Current active records from Gold.Dim_Customer in Azure SQL",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "sinks": [
                {
                    "name": "UpdateExpiredRows",
                    "description": "Updates existing rows: sets IsActive=0 and ValidTo=now() for changed records",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                },
                {
                    "name": "InsertNewVersions",
                    "description": "Inserts new rows for both brand-new customers and new versions of changed customers",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "transformations": [
                {
                    "name": "HashNewData",
                    "description": "Creates SHA256 hash of business columns in new data for change detection"
                },
                {
                    "name": "HashExistingData",
                    "description": "Creates SHA256 hash of business columns in existing dimension for comparison"
                },
                {
                    "name": "LookupExisting",
                    "description": "Matches new records to existing dimension on business key"
                },
                {
                    "name": "SplitByChangeStatus",
                    "description": "Routes rows into NewRecords, ChangedRecords, or NoChange"
                },
                {
                    "name": "MarkForUpdate",
                    "description": "Marks changed records for UPDATE"
                },
                {
                    "name": "MarkForInsert",
                    "description": "Marks new and changed records for INSERT"
                },
                {
                    "name": "SetExpiredColumns",
                    "description": "Sets IsActive=0 and ValidTo=now for expired rows"
                },
                {
                    "name": "SetNewVersionColumns",
                    "description": "Sets IsActive=1, ValidFrom=now, ValidTo=null for new versions"
                }
            ],
            "scriptLines": [
                "source(output(",
                "    ABAN8 as integer,",
                "    ABALPH as string,",
                "    ABAT1 as string,",
                "    ABAC01 as string,",
                "    ABUPMJ as integer",
                "),",
                "allowSchemaDrift: false,",
                "validateSchema: false) ~> NewCustomerData",
                "",
                "source(output(",
                "    CustomerKey as integer,",
                "    CustomerID as integer,",
                "    CustomerName as string,",
                "    SearchType as string,",
                "    CategoryCode as string,",
                "    IsActive as boolean,",
                "    ValidFrom as timestamp,",
                "    ValidTo as timestamp,",
                "    RowHash as string",
                "),",
                "allowSchemaDrift: false,",
                "validateSchema: false) ~> ExistingDimCustomer",
                "",
                "NewCustomerData derive(",
                "    NewHash = sha2(256, columns())",
                ") ~> HashNewData",
                "",
                "ExistingDimCustomer derive(",
                "    ExistingHash = sha2(256, CustomerName, SearchType, CategoryCode)",
                ") ~> HashExistingData",
                "",
                "HashNewData, HashExistingData lookup(",
                "    ABAN8 == CustomerID,",
                "    multiple: false,",
                "    broadcast: 'auto'",
                ") ~> LookupExisting",
                "",
                "LookupExisting split(",
                "    isNull(CustomerKey),",
                "    !isNull(CustomerKey) && NewHash != ExistingHash,",
                "    disjoint: false",
                ") ~> SplitByChangeStatus@(NewRecords, ChangedRecords, NoChange)",
                "",
                "SplitByChangeStatus@ChangedRecords alterRow(",
                "    updateIf: true()",
                ") ~> MarkForUpdate",
                "",
                "SplitByChangeStatus@NewRecords, SplitByChangeStatus@ChangedRecords alterRow(",
                "    insertIf: true()",
                ") ~> MarkForInsert",
                "",
                "MarkForUpdate derive(",
                "    IsActive = false(),",
                "    ValidTo = currentTimestamp(),",
                "    ModifiedDate = currentTimestamp()",
                ") ~> SetExpiredColumns",
                "",
                "MarkForInsert derive(",
                "    CustomerID_out = ABAN8,",
                "    CustomerName_out = ABALPH,",
                "    SearchType_out = ABAT1,",
                "    CategoryCode_out = ABAC01,",
                "    IsActive_out = true(),",
                "    ValidFrom_out = currentTimestamp(),",
                "    RowHash_out = NewHash",
                ") ~> SetNewVersionColumns",
                "",
                "SetExpiredColumns sink(",
                "    allowSchemaDrift: false,",
                "    validateSchema: false,",
                "    deletable: false,",
                "    insertable: false,",
                "    updateable: true,",
                "    upsertable: false,",
                "    keys: ['CustomerKey'],",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerKey,",
                "        IsActive,",
                "        ValidTo,",
                "        ModifiedDate",
                "    )",
                ") ~> UpdateExpiredRows",
                "",
                "SetNewVersionColumns sink(",
                "    allowSchemaDrift: false,",
                "    validateSchema: false,",
                "    deletable: false,",
                "    insertable: true,",
                "    updateable: false,",
                "    upsertable: false,",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerID = CustomerID_out,",
                "        CustomerName = CustomerName_out,",
                "        SearchType = SearchType_out,",
                "        CategoryCode = CategoryCode_out,",
                "        IsActive = IsActive_out,",
                "        ValidFrom = ValidFrom_out,",
                "        RowHash = RowHash_out",
                "    )",
                ") ~> InsertNewVersions"
            ]
        }
    }
}