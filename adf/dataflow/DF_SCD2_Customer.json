{
    "name": "DF_SCD2_Customer",
    "type": "Microsoft.DataFactory/factories/dataflows",
    "properties": {
        "description": "Mapping Data Flow implementing Slowly Changing Dimensions Type 2 for the Customer dimension. Uses SHA256 hashing for efficient change detection and manages row versioning (IsActive, ValidFrom, ValidTo).",
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "NewCustomerData",
                    "description": "New/updated customer records from Bronze F0101 Parquet",
                    "dataset": {
                        "referenceName": "ds_bronze_parquet",
                        "type": "DatasetReference",
                        "parameters": {
                            "TableName": "jde/F0101"
                        }
                    }
                },
                {
                    "name": "ExistingDimCustomer",
                    "description": "Current active records from Gold.Dim_Customer in Azure SQL",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "sinks": [
                {
                    "name": "UpdateExpiredRows",
                    "description": "Updates existing rows: sets IsActive=0 and ValidTo=now() for changed records",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                },
                {
                    "name": "InsertNewVersions",
                    "description": "Inserts new rows: both brand-new customers and new versions of changed customers with IsActive=1",
                    "dataset": {
                        "referenceName": "ds_gold_sql",
                        "type": "DatasetReference",
                        "parameters": {
                            "SchemaName": "Gold",
                            "TableName": "Dim_Customer"
                        }
                    }
                }
            ],
            "transformations": [
                {
                    "name": "HashNewData",
                    "description": "Creates SHA256 hash of business columns in new data for change detection"
                },
                {
                    "name": "HashExistingData",
                    "description": "Creates SHA256 hash of business columns in existing dimension for comparison"
                },
                {
                    "name": "LookupExisting",
                    "description": "Matches new records to existing dimension on business key (ABAN8/CustomerID)"
                },
                {
                    "name": "ConditionalSplit",
                    "description": "Splits into: NewRecords (no match), ChangedRecords (hash mismatch), NoChange (hash match)"
                },
                {
                    "name": "AlterRow_Update",
                    "description": "Marks changed records for UPDATE (IsActive=0, ValidTo=now)"
                },
                {
                    "name": "AlterRow_Insert",
                    "description": "Marks new + changed records for INSERT (IsActive=1, ValidTo=NULL)"
                }
            ],
            "scriptLines": [
                "// ============================================================",
                "// SOURCE 1: New customer data from Bronze F0101",
                "// ============================================================",
                "source(output(",
                "    ABAN8 as integer,",
                "    ABALPH as string,",
                "    ABAT1 as string,",
                "    ABAC01 as string,",
                "    ABUPMJ as integer",
                "),",
                "allowSchemaDrift: false,",
                "validateSchema: true) ~> NewCustomerData",
                "",
                "// ============================================================",
                "// SOURCE 2: Existing active rows from Gold.Dim_Customer",
                "// ============================================================",
                "source(output(",
                "    CustomerKey as integer,",
                "    CustomerID as integer,",
                "    CustomerName as string,",
                "    SearchType as string,",
                "    CategoryCode as string,",
                "    IsActive as boolean,",
                "    ValidFrom as timestamp,",
                "    ValidTo as timestamp,",
                "    RowHash as string",
                "),",
                "allowSchemaDrift: false,",
                "validateSchema: true,",
                "query: 'SELECT * FROM Gold.Dim_Customer WHERE IsActive = 1'",
                ") ~> ExistingDimCustomer",
                "",
                "// ============================================================",
                "// HASH: Create SHA256 of business columns in new data",
                "// ============================================================",
                "NewCustomerData derive(",
                "    NewHash = sha2(256, ABALPH, ABAT1, ABAC01)",
                ") ~> HashNewData",
                "",
                "// ============================================================",
                "// HASH: Create SHA256 of business columns in existing data",
                "// ============================================================",
                "ExistingDimCustomer derive(",
                "    ExistingHash = sha2(256, CustomerName, SearchType, CategoryCode)",
                ") ~> HashExistingData",
                "",
                "// ============================================================",
                "// LOOKUP: Match new data to existing on business key",
                "// ============================================================",
                "HashNewData, HashExistingData lookup(",
                "    ABAN8 == CustomerID,",
                "    multiple: false,",
                "    broadcast: 'auto'",
                ") ~> LookupExisting",
                "",
                "// ============================================================",
                "// CONDITIONAL SPLIT: Route rows by change status",
                "// ============================================================",
                "LookupExisting split(",
                "    isNull(CustomerKey),",
                "    !isNull(CustomerKey) && NewHash != ExistingHash,",
                "    disjoint: false",
                ") ~> ConditionalSplit@(NewRecords, ChangedRecords, NoChange)",
                "",
                "// ============================================================",
                "// ALTER ROW: Mark changed records for UPDATE",
                "// Sets IsActive=0, ValidTo=currentTimestamp()",
                "// ============================================================",
                "ConditionalSplit@ChangedRecords alterRow(",
                "    updateIf: true()",
                ") ~> AlterRow_Update",
                "",
                "// ============================================================",
                "// ALTER ROW: Mark new + changed (new version) for INSERT",
                "// Sets IsActive=1, ValidFrom=currentTimestamp(), ValidTo=NULL",
                "// ============================================================",
                "ConditionalSplit@NewRecords, ConditionalSplit@ChangedRecords alterRow(",
                "    insertIf: true()",
                ") ~> AlterRow_Insert",
                "",
                "// ============================================================",
                "// SINK 1: UPDATE expired rows (execute BEFORE inserts)",
                "// ============================================================",
                "AlterRow_Update sink(",
                "    allowSchemaDrift: false,",
                "    validateSchema: true,",
                "    input(",
                "        CustomerKey as integer,",
                "        IsActive as boolean,",
                "        ValidTo as timestamp",
                "    ),",
                "    deletable: false,",
                "    insertable: false,",
                "    updateable: true,",
                "    upsertable: false,",
                "    keys: ['CustomerKey'],",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerKey,",
                "        IsActive = false,",
                "        ValidTo = currentTimestamp()",
                "    ),",
                "    sinkOrder: 1",
                ") ~> UpdateExpiredRows",
                "",
                "// ============================================================",
                "// SINK 2: INSERT new versions (execute AFTER updates)",
                "// ============================================================",
                "AlterRow_Insert sink(",
                "    allowSchemaDrift: false,",
                "    validateSchema: true,",
                "    input(",
                "        CustomerID as integer,",
                "        CustomerName as string,",
                "        SearchType as string,",
                "        CategoryCode as string,",
                "        IsActive as boolean,",
                "        ValidFrom as timestamp,",
                "        ValidTo as timestamp,",
                "        RowHash as string",
                "    ),",
                "    deletable: false,",
                "    insertable: true,",
                "    updateable: false,",
                "    upsertable: false,",
                "    format: 'table',",
                "    mapColumn(",
                "        CustomerID = ABAN8,",
                "        CustomerName = ABALPH,",
                "        SearchType = ABAT1,",
                "        CategoryCode = ABAC01,",
                "        IsActive = true,",
                "        ValidFrom = currentTimestamp(),",
                "        ValidTo = toTimestamp(null),",
                "        RowHash = NewHash",
                "    ),",
                "    sinkOrder: 2",
                ") ~> InsertNewVersions"
            ]
        }
    }
}